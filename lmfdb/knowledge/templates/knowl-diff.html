
  <script type="text/javascript" src="/static/diff_match_patch.js"></script>
  <script type="text/javascript">


var content_history = [
  {% for elt in k.edit_history|reverse %}
    {{ elt.content|string|safe }},
  {%endfor%}
]

function new_text(version) {
  if( version == -1) {
    return $('#kcontent').val();
  }
  else {
    return content_history[version];
  }
};



$("body").on("change", '#lhsselect', function() {
  $('#compare').mergely('lhs', new_text(parseInt($('#lhsselect').val())));
  $('#compare').mergely('resize');
}
);


$("body").on("change", '#rhsselect', function() {
  $('#compare').mergely('rhs', new_text(parseInt($('#rhsselect').val())));
  $('#compare').trigger('resize');
}
);

$("body").on("keyup", '#kcontent', function() {
  $('#lhsselect').trigger("change");
  $('#rhsselect').trigger("change");
}
);


$(document).ready(function () {
  var lhsselect = $('#lhsselect');
  var rhsselect = $('#rhsselect');
  var comp = $('#compare');
  comp.mergely({
    license: 'gpl-separate-notice',
    cmsettings: {
      readOnly: true,
      linewrap: true,
      viewportMargin: 50,
    },
    lineNumbers: true,
    wrap_lines: true,
    width: 'auto',
    height: 'calc(100vh - 200px)',
    ignorews: true,
  });
  // in editing mode?
  if(typeof $kcontent !== 'undefined') {
    // insert edition as an option
    lhsselect.prepend($("<option></option>")
      .attr("value","-1")
      .text("editing")
      .prop('selected', true)
    );
    if(content_history.length > 0) {
      lhsselect.val("0").change();
    }
    rhsselect.prepend($("<option></option>")
      .attr("value","-1")
      .text("editing")
      .prop('selected', true)
    );
    lhsselect.trigger("change");
    rhsselect.trigger("change");
    comp.trigger('resize');

    }// end if editing
  });




/*
    function diff(text1, text2) {
      var dmp = new diff_match_patch();
      dmp.Diff_Timeout = 2;//parseFloat(document.getElementById('timeout').value);
      dmp.Diff_EditCost = 5;
      var diffs = dmp.diff_main(text1, text2);
      //dmp.diff_cleanupSemantic(d);
      dmp.diff_cleanupEfficiency(diffs);
      var ds = dmp.diff_prettyHtml(diffs).replace(/&para;<br>/g,'');
      return ds;
    };
    var inline = $('#compareinline');

    function wait_for_text(){
      if(lhs != null && rhs != null){
        inline.html( '<pre>' + diff(lhs, rhs) + '</pre>');
      }
      else{
        setTimeout(wait_for_text, 250);
      }
    }
    setTimeout(wait_for_text, 250);
*/
  //try
  //{
  //renderMathInElement(inline.get(0), katexOpts);
  //}
  //catch(err) {
  //log("err:" + err)
  //}

  //jQuery.extend
  //(
  //    {
  //        getValues: function(url, type) 
  //        {
  //            var result = null;
  //            $.ajax(
  //                {
  //                    url: url,
  //                    type: 'get',
  //                    dataType: 'html',
  //                    async: false,
  //                    cache: false,
  //                    success: function(data) 
  //                    {
  //                        result = data;
  //                    }
  //                }
  //            );
  //           return result;
  //        }
  //    }
  //);

</script>
<style>
/* Initial height */
.diff {
  overflow: auto;
  resize: vertical;
  padding: 20px;
}
 /* Auto-height fix */
 .mergely-column .CodeMirror {
   height: auto;
 }

 .inline{
   font-family: monospace;
 }
 pre {
   white-space: pre-wrap;       /* Since CSS 2.1 */
   white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
   white-space: -pre-wrap;      /* Opera 4-6 */
   white-space: -o-pre-wrap;    /* Opera 7 */
   word-wrap: break-word;       /* Internet Explorer 5.5+ */
 }
 del {
   background: #FFE6E6;
 }
 ins {
   background: #E6FFE6;
 }
</style>

<div id='diffselector'>
<table style="width: 100%">
  <!--
  <tr>
    <th> Left hand side</th>
    <th> Right hand side</th>
    </tr>
  -->
    <tr>
      <td align="center">
        <form>
          <select id='lhsselect' size="4">
            {% for elt in k.edit_history|reverse %}
              <option value='{{loop.index0}}'>
              {{((elt.timestamp|fmtdatetime)|string) + " by " + (elt.author_full_name|string)}}
              {% if elt.status == 1 %}
                (Reviewed)
              {% endif %}
              </option>
            {% endfor %}
          </select>
        </form>
      </td>
      <td align="center">
        <form>
          <select id='rhsselect' size="4">
            {% for elt in k.edit_history|reverse %}
              <option value='{{loop.index0}}'>
              {{((elt.timestamp|fmtdatetime)|string) + " by " + (elt.author_full_name|string)}}
              {% if elt.status == 1 %}
                (Reviewed)
              {% endif %}
              </option>
            {% endfor %}
          </select>
        </form>
      </td>
    </tr>
</table>
</div>
<div class="diff">
  <div id="compare"></div>
</div>
<div class="inline">
  <div id="compareinline"></div>
</div>



