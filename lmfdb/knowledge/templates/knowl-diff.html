<!-- CodeMirror -->
<script defer
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.js"
      integrity="sha384-FI6pF4jT5OLWJXc3EzvnyZEFcAwREFlPw81bB9gbkmyesoJHMq9TxE/CA0PZ7nF6"
      crossorigin="anonymous"></script>
<script defer
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/addon/search/searchcursor.min.js"
      integrity="sha384-ytTGJfQEcykPzyWakPMXw3UUCtFeMOeMu43uMWb/0EQoW3F5zzg+06D8pDJDtbd5"
      crossorigin="anonymous"></script>
<link type="text/css"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.css"
      integrity="sha384-qHr0tRKUJCVvDPBkv5JnUcctfAqzS0Qo1NrKtq8O0YNp/0zygS/9JepLTiPLVQkG"
      crossorigin="anonymous"/>

<!-- Mergely  -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/mergely@4.0.11/lib/mergely.css"
      integrity="sha384-N8G4oBuDTLxH6t1v7bNdCcv56sJDJH6JArcx9uKz4vSMFvNjyXDjOyKBsSQy1o5K"
      crossorigin="anonymous">
<script defer
      src="https://cdn.jsdelivr.net/npm/mergely@4.0.11/lib/mergely.js"
      integrity="sha384-VN5LSIgtGg3krjINbmlVY/4hG2PyALw4wy5wpCC8gxJ+VrpZsyUxlvNwcQq7CDGQ"
      crossorigin="anonymous"></script>
<script type="text/javascript" src="/static/diff_match_patch.js"></script>
<script type="text/javascript">

  function diff(text1, text2) {
    var dmp = new diff_match_patch();
    dmp.Diff_Timeout = 2;//parseFloat(document.getElementById('timeout').value);
    dmp.Diff_EditCost = 5;
    var diffs = dmp.diff_main(text1, text2);
    //dmp.diff_cleanupSemantic(d);
    dmp.diff_cleanupEfficiency(diffs);
    var ds = dmp.diff_prettyHtml(diffs).replace(/&para;<br>/g,'');
    return ds;
  };

var content_history = [
  {% for elt in k.edit_history|reverse %}
    {{ elt.content|string|safe }},
  {%endfor%}
]

function new_text(version) {
  if( version == -1) {
    return $('#kcontent').val();
  }
  else if ( version >= 0 && version < content_history.length ) {
    return content_history[version];
  }
  else {
    return '';
  }
};

$(document).ready(function () {
  var diffmode='sidebyside';
  var lhsselect = $('#lhsselect');
  var rhsselect = $('#rhsselect');
  var comp = $('#compare');
  comp.mergely({
    license: 'gpl-separate-notice',
    cmsettings: {
      readOnly: true,
      linewrap: true,
      viewportMargin: 50,
    },
    lineNumbers: true,
    wrap_lines: true,
    width: 'auto',
    height: 'calc(100vh - 200px)',
    ignorews: false,
  });

  lhsselect.change( function() {
    lhs = new_text(parseInt(lhsselect.val()));
    if (diffmode == 'sidebyside') {
      $('#compare').mergely('lhs', lhs);
      $('#compare').mergely('resize');
    } else {
      rhs = new_text(parseInt(rhsselect.val()));
      $('#compareinline').html('<pre>' + diff(lhs, rhs) + '</pre>');
    }
  });


  rhsselect.change( function() {
    rhs = new_text(parseInt($('#rhsselect').val()));
    if (diffmode == 'sidebyside') {
      $('#compare').mergely('rhs', rhs);
      $('#compare').trigger('resize');
    } else {
      lhs = new_text(parseInt($('#lhsselect').val()));
      $('#compareinline').html('<pre>' + diff(lhs, rhs) + '</pre>');
    }
  });

  {# in editing mode? #}
  {% if k.editing %}
    // insert edition as an option
    lhsselect.prepend($("<option></option>")
                      .attr("value","-1")
                      .text("editing")
                      .prop('selected', true)
                      );

    if(content_history.length > 0) {
      lhsselect.val("0").change();
    }
    rhsselect.prepend($("<option></option>")
                      .attr("value","-1")
                      .text("editing")
                      .prop('selected', true)
                      );

    lhsselect.trigger("change");
    rhsselect.trigger("change");

    $kcontent.keyup( function() {
      lhsselect.trigger("change");
      rhsselect.trigger("change");
    });
  {% else %}
    rhsselect.val("0").change();
    {% if k.previous_review_spot %}
      {# we have reversed the indexes #}
      lhsselect.val("{{(k.edit_history|length) - 1 - k.previous_review_spot}}").change();
    {% else %}
      lhsselect.val("1").change();
    {% endif %}
  {% endif %} {# end if editing #}
  comp.trigger('resize');

  $('#inline_button').click( function(evt){
    evt.preventDefault();
    diffmode = 'inline';
    lhsselect.trigger("change");
    $(".sidebyside").hide('fast');
    $(".inline").show('fast');
  });
  $('#sidebyside_button').click( function(evt){
    evt.preventDefault();
    diffmode = 'sidebyside';
    lhsselect.trigger("change");
    rhsselect.trigger("change");
    comp.trigger('resize');
    $(".inline").hide('fast');
    $(".sidebyside").show('fast');
  });
  });

</script>
<style>
/* Initial height */
.sidebyside_wrapper {
  overflow: auto;
  resize: vertical;
  padding: 20px;
}
 /* Auto-height fix */
 .mergely-column .CodeMirror {
   height: auto;
 }

 .inline{
   font-family: 12px 'Courier New', Courier, monospace;
   z-index: auto;
   position: relative;
   line-height: 18px;
   transition: none 0s ease 0s;
   background: transparent !important;
   background-color: white;
   overflow-wrap: break-word;
   padding: 2px;
 }
 pre {
   -webkit-rtl-ordering: logical;
   -webkit-appearance: textarea;
   white-space: pre-wrap;       /* Since CSS 2.1 */
   white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
   white-space: -pre-wrap;      /* Opera 4-6 */
   white-space: -o-pre-wrap;    /* Opera 7 */
   word-wrap: break-word;       /* Internet Explorer 5.5+ */
 }
 del {
   background: #FFE6E6;
 }
 ins {
   background: #E6FFE6;
 }
</style>

<div id='diffselector'>
  <table style="width: 100%">
    <!--
      <tr>
      <th> Left hand side</th>
      <th> Right hand side</th>
      </tr>
    -->
    <tr>
      <td align="center">
        <form>
          <select id='lhsselect' size="4">
            {% for elt in k.edit_history|reverse %}
              <option value='{{loop.index0}}'>
              {{((elt.timestamp|fmtdatetime)|string) + " by " + (elt.author_full_name|string)}}
              {% if elt.status == 1 %}
                (Reviewed)
              {% endif %}
              </option>
            {% endfor %}
          </select>
        </form>
      </td>
      <td align="center">
        <form>
          <select id='rhsselect' size="4">
            {% for elt in k.edit_history|reverse %}
              <option value='{{loop.index0}}'>
              {{((elt.timestamp|fmtdatetime)|string) + " by " + (elt.author_full_name|string)}}
              {% if elt.status == 1 %}
                (Reviewed)
              {% endif %}
              </option>
            {% endfor %}
          </select>
        </form>
      </td>
    </tr>
  </table>
</div>
<div class="sidebyside">
  <strong> Side by side </strong>
  <a href="#" id="inline_button">(inline)</a>
  <div class="sidebyside_wrapper">
    <div id="compare"></div>
  </div>
</div>

<div class="inline" style="display: none;" sytle>
  <strong> Inline </strong>
  <a href="#" id="sidebyside_button">(side by side)</a>
  <div id="compareinline"></div>
</div>



